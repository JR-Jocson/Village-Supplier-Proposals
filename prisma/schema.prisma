// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Note: directUrl removed - using db push for schema changes when migrations can't connect
  // For migrations, use: npx prisma db push (works with DATABASE_URL)
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // Hashed password
  name      String
  role      String   @default("user") // user, admin
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Project {
  id              String       @id @default(uuid())
  kibbutzName     String       // Name of the kibbutz/settlement
  projectName     String       // Name of the project as written in Local Committee Approval
  submitterName   String       // Name of the person who submitted
  submitterEmail  String       // Email of the submitter
  submitterPhone  String       // Phone number of the submitter
  invoicePrice    Float?       // DEPRECATED: Detected price from invoice (kept for backward compatibility)
  totalProjectCost Float?      // Total cost of the entire project
  additionalNotes String?      // Additional notes from submitter (up to 1000 chars)
  status          String       @default("draft") // draft, submitted, reviewed, etc.
  laApproval      Boolean?     // Whether LA approval was received for the project
  avivaApproval   Boolean?     // Whether Aviva's approval for a public building was received
  files           ProjectFile[]
  invoices        Invoice[]    // Invoices associated with this project
  analysis        ProjectAnalysis?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model ProjectFile {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  invoiceId   String?  // Link to invoice if file is invoice-specific (proposals, tenders, or invoice file)
  invoice     Invoice? @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  fileName    String   // Original file name
  filePath    String   // Path in Supabase Storage bucket
  fileType    String   // invoice, proposal, tender, committee_approval, charge_notice
  fileSize    Int      // File size in bytes
  mimeType    String   // MIME type (e.g., application/pdf)
  proposalIndex Int?   // For proposal files: which proposal number (1, 2, 3, or 4)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([invoiceId])
}

model Invoice {
  id          String       @id @default(uuid())
  projectId   String
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  price       Float        // Price of this specific invoice
  files       ProjectFile[] // Files associated with this invoice (invoices, proposals, tenders)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([projectId])
}

model ProjectAnalysis {
  id              String   @id @default(uuid())
  projectId       String   @unique
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  isApproved      Boolean? // true = good, false = needs second look, null = pending analysis
  analysisNotes   String?  // AI reasoning/explanation for the decision
  confidenceScore Float?   // Confidence score from AI (0.0 to 1.0)
  issues          String[] @default([]) // Array of problems/issues that need to be resolved
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([projectId])
}

